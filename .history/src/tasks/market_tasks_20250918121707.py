"""
Tarefas especializadas para an√°lise de mercado financeiro.
"""

from crewai import Task
from typing import Dict, Any, Optional
from datetime import datetime


class MarketTasks:
    """Classe para criar e gerenciar tarefas de an√°lise de mercado."""
    
    def __init__(self):
        """Inicializa a classe de tarefas."""
        self.current_date = datetime.now().strftime("%d/%m/%Y")
    
    def create_research_task(self, symbol: str, agent) -> Task:
        """
        Cria tarefa de pesquisa de mercado.
        
        Args:
            symbol: S√≠mbolo da a√ß√£o a ser analisada
            agent: Agente respons√°vel pela tarefa
            
        Returns:
            Task: Tarefa configurada para pesquisa
        """
        return Task(
            description=f"""Realizar pesquisa abrangente sobre a empresa {symbol}, incluindo:

            1. IDENTIFICA√á√ÉO DA EMPRESA:
               ‚Ä¢ Nome completo e setor de atua√ß√£o
               ‚Ä¢ Principais produtos/servi√ßos
               ‚Ä¢ Posi√ß√£o competitiva no mercado
               ‚Ä¢ Principais concorrentes

            2. AN√ÅLISE DE NOT√çCIAS E SENTIMENTO:
               ‚Ä¢ √öltimas not√≠cias relevantes (30 dias)
               ‚Ä¢ An√°lise de sentimento de mercado
               ‚Ä¢ Eventos corporativos recentes
               ‚Ä¢ Comunicados relevantes da empresa

            3. CONTEXTO MACROECON√îMICO:
               ‚Ä¢ Cen√°rio econ√¥mico brasileiro atual
               ‚Ä¢ Impacto dos indicadores macro no setor
               ‚Ä¢ Tend√™ncias globais que afetam a empresa
               ‚Ä¢ Pol√≠tica monet√°ria e fiscal

            4. AN√ÅLISE SETORIAL:
               ‚Ä¢ Performance do setor vs mercado
               ‚Ä¢ Tend√™ncias e desafios setoriais
               ‚Ä¢ Regulamenta√ß√µes relevantes
               ‚Ä¢ Oportunidades e amea√ßas

            5. DADOS PRELIMINARES:
               ‚Ä¢ Cota√ß√£o atual e varia√ß√£o recente
               ‚Ä¢ Volume de negocia√ß√£o
               ‚Ä¢ M√∫ltiplos b√°sicos de mercado
               
            Organize as informa√ß√µes de forma estruturada e destaque os pontos mais relevantes
            para a an√°lise subsequente pelos outros especialistas.
            
            Data da an√°lise: {self.current_date}
            """,
            expected_output=f"""Relat√≥rio estruturado de pesquisa sobre {symbol} contendo:
            
            üìä RESUMO EXECUTIVO
            ‚Ä¢ Vis√£o geral da empresa e setor
            ‚Ä¢ Principais destaques e preocupa√ß√µes
            ‚Ä¢ Contexto atual de mercado
            
            üè¢ PERFIL DA EMPRESA
            ‚Ä¢ Informa√ß√µes corporativas detalhadas
            ‚Ä¢ Modelo de neg√≥cio e posicionamento
            ‚Ä¢ Principais produtos/segmentos
            
            üì∞ AN√ÅLISE DE NOT√çCIAS (30 dias)
            ‚Ä¢ Resumo das principais not√≠cias
            ‚Ä¢ An√°lise de sentimento
            ‚Ä¢ Eventos corporativos relevantes
            
            üåç CEN√ÅRIO MACROECON√îMICO
            ‚Ä¢ Contexto econ√¥mico brasileiro
            ‚Ä¢ Impactos setoriais
            ‚Ä¢ Fatores de risco e oportunidade
            
            üìà DADOS PRELIMINARES DE MERCADO
            ‚Ä¢ Pre√ßo e varia√ß√£o atual
            ‚Ä¢ Volume e liquidez
            ‚Ä¢ M√∫ltiplos b√°sicos
            
            ‚ö° PONTOS DE ATEN√á√ÉO
            ‚Ä¢ Fatores cr√≠ticos para monitoramento
            ‚Ä¢ Riscos identificados
            ‚Ä¢ Oportunidades potenciais
            
            Formato: Markdown com emojis e formata√ß√£o clara""",
            agent=agent,
            context=[],
            output_file=f"reports/research_{symbol}_{datetime.now().strftime('%Y%m%d_%H%M')}.md"
        )

    def create_fundamental_analysis_task(self, symbol: str, agent, research_task: Task) -> Task:
        """
        Cria tarefa de an√°lise fundamentalista.
        
        Args:
            symbol: S√≠mbolo da a√ß√£o
            agent: Agente respons√°vel
            research_task: Tarefa de pesquisa pr√©via
            
        Returns:
            Task: Tarefa de an√°lise fundamentalista
        """
        return Task(
            description=f"""Realizar an√°lise fundamentalista completa da empresa {symbol}, baseando-se 
            na pesquisa inicial e incluindo:

            1. AN√ÅLISE FINANCEIRA DETALHADA:
               ‚Ä¢ Demonstra√ß√£o de Resultados (√∫ltimos 4 anos)
               ‚Ä¢ Balan√ßo Patrimonial (√∫ltimos 4 anos)
               ‚Ä¢ Demonstra√ß√£o de Fluxo de Caixa (√∫ltimos 4 anos)
               ‚Ä¢ Evolu√ß√£o de receitas, margens e lucros
               ‚Ä¢ Qualidade dos resultados financeiros

            2. INDICADORES FUNDAMENTALISTAS:
               ‚Ä¢ M√∫ltiplos de valuation (P/L, P/VPA, EV/EBITDA)
               ‚Ä¢ Indicadores de rentabilidade (ROE, ROA, ROIC)
               ‚Ä¢ Indicadores de endividamento (D/E, Liquidez)
               ‚Ä¢ Indicadores de efici√™ncia operacional
               ‚Ä¢ Compara√ß√£o com peers do setor

            3. AN√ÅLISE DE CRESCIMENTO:
               ‚Ä¢ Taxa de crescimento hist√≥rica (receitas/lucros)
               ‚Ä¢ Proje√ß√µes de crescimento futuro
               ‚Ä¢ Drivers de crescimento identificados
               ‚Ä¢ Sustentabilidade do crescimento

            4. AN√ÅLISE DE DIVIDENDOS:
               ‚Ä¢ Hist√≥rico de distribui√ß√£o de dividendos
               ‚Ä¢ Yield de dividendos atual e hist√≥rico
               ‚Ä¢ Pol√≠tica de dividendos da empresa
               ‚Ä¢ Capacidade de manuten√ß√£o dos dividendos

            5. VALUATION E PRE√áO JUSTO:
               ‚Ä¢ Modelos de valuation (DCF, m√∫ltiplos)
               ‚Ä¢ Pre√ßo-alvo baseado em fundamentos
               ‚Ä¢ Cen√°rios otimista, base e pessimista
               ‚Ä¢ Margem de seguran√ßa atual

            6. FOR√áAS E FRAQUEZAS:
               ‚Ä¢ Vantagens competitivas identificadas
               ‚Ä¢ Pontos fracos e vulnerabilidades
               ‚Ä¢ Posi√ß√£o financeira e solidez
               ‚Ä¢ Qualidade da gest√£o e governan√ßa

            Data da an√°lise: {self.current_date}
            """,
            expected_output=f"""An√°lise fundamentalista abrangente de {symbol} incluindo:
            
            üíº RESUMO EXECUTIVO FUNDAMENTALISTA
            ‚Ä¢ Tese de investimento principal
            ‚Ä¢ Recomenda√ß√£o fundamentalista (Compra/Mantenha/Venda)
            ‚Ä¢ Pre√ßo-alvo e potencial de valoriza√ß√£o
            ‚Ä¢ Principais riscos e catalisadores
            
            üìä AN√ÅLISE FINANCEIRA HIST√ìRICA
            ‚Ä¢ Performance de receitas, margens e lucros (4 anos)
            ‚Ä¢ Evolu√ß√£o dos indicadores de rentabilidade
            ‚Ä¢ An√°lise da estrutura de capital
            ‚Ä¢ Qualidade e consist√™ncia dos resultados
            
            üî¢ INDICADORES FUNDAMENTALISTAS
            ‚Ä¢ M√∫ltiplos de valuation vs peers
            ‚Ä¢ Indicadores de rentabilidade e efici√™ncia
            ‚Ä¢ M√©tricas de endividamento e liquidez
            ‚Ä¢ Compara√ß√£o setorial e hist√≥rica
            
            üí∞ AN√ÅLISE DE DIVIDENDOS
            ‚Ä¢ Hist√≥rico e sustentabilidade dos dividendos
            ‚Ä¢ Yield atual vs hist√≥rico vs setor
            ‚Ä¢ Pol√≠tica de dividendos e payout ratio
            ‚Ä¢ Proje√ß√£o de dividendos futuros
            
            üéØ VALUATION E PRE√áO JUSTO
            ‚Ä¢ Modelos de valuation aplicados
            ‚Ä¢ Pre√ßo-alvo em diferentes cen√°rios
            ‚Ä¢ Margem de seguran√ßa atual
            ‚Ä¢ Sensibilidade √†s principais vari√°veis
            
            ‚öñÔ∏è RISCOS E OPORTUNIDADES
            ‚Ä¢ Principais riscos fundamentalistas
            ‚Ä¢ Catalisadores de valor identificados
            ‚Ä¢ Vantagens competitivas sustent√°veis
            ‚Ä¢ Fatores de monitoramento
            
            üìà RECOMENDA√á√ÉO FINAL
            ‚Ä¢ Rating fundamentalista
            ‚Ä¢ Horizonte de investimento recomendado
            ‚Ä¢ Estrat√©gia de entrada/sa√≠da
            ‚Ä¢ Pontos de reavalia√ß√£o
            
            Formato: Markdown detalhado com tabelas e gr√°ficos quando aplic√°vel""",
            agent=agent,
            context=[research_task],
            output_file=f"reports/fundamental_{symbol}_{datetime.now().strftime('%Y%m%d_%H%M')}.md"
        )

    def create_technical_analysis_task(self, symbol: str, agent, research_task: Task) -> Task:
        """
        Cria tarefa de an√°lise t√©cnica.
        
        Args:
            symbol: S√≠mbolo da a√ß√£o
            agent: Agente respons√°vel
            research_task: Tarefa de pesquisa pr√©via
            
        Returns:
            Task: Tarefa de an√°lise t√©cnica
        """
        return Task(
            description=f"""Realizar an√°lise t√©cnica completa da a√ß√£o {symbol}, incluindo:

            1. AN√ÅLISE DE TEND√äNCIA:
               ‚Ä¢ Identifica√ß√£o da tend√™ncia principal (prim√°ria, secund√°ria, terci√°ria)
               ‚Ä¢ An√°lise de m√∫ltiplos timeframes (di√°rio, semanal, mensal)
               ‚Ä¢ Estrutura de topos e fundos
               ‚Ä¢ Rompimentos e confirma√ß√µes de tend√™ncia

            2. SUPORTE E RESIST√äNCIA:
               ‚Ä¢ N√≠veis de suporte e resist√™ncia relevantes
               ‚Ä¢ Zonas de acumula√ß√£o e distribui√ß√£o
               ‚Ä¢ N√≠veis psicol√≥gicos importantes
               ‚Ä¢ Retra√ß√µes de Fibonacci

            3. INDICADORES T√âCNICOS:
               ‚Ä¢ RSI (Relative Strength Index)
               ‚Ä¢ MACD (Moving Average Convergence Divergence)
               ‚Ä¢ M√©dias m√≥veis (20, 50, 200 per√≠odos)
               ‚Ä¢ Bandas de Bollinger
               ‚Ä¢ Volume e indicadores de volume

            4. PADR√ïES GR√ÅFICOS:
               ‚Ä¢ Padr√µes de candlestick relevantes
               ‚Ä¢ Forma√ß√µes gr√°ficas (tri√¢ngulos, ret√¢ngulos, etc.)
               ‚Ä¢ Gaps e suas implica√ß√µes
               ‚Ä¢ Padr√µes de revers√£o ou continua√ß√£o

            5. AN√ÅLISE DE VOLUME:
               ‚Ä¢ Volume m√©dio vs volume atual
               ‚Ä¢ Diverg√™ncias de volume
               ‚Ä¢ Volume nos rompimentos
               ‚Ä¢ An√°lise de fluxo de capital

            6. MOMENTUM E FOR√áA RELATIVA:
               ‚Ä¢ Indicadores de momentum
               ‚Ä¢ For√ßa relativa vs √≠ndice (IBOV)
               ‚Ä¢ Sinais de sobrecompra/sobrevenda
               ‚Ä¢ Diverg√™ncias de momentum

            7. CEN√ÅRIOS T√âCNICOS:
               ‚Ä¢ Cen√°rio altista: alvos e estrat√©gia
               ‚Ä¢ Cen√°rio baixista: suportes e stops
               ‚Ä¢ N√≠veis de entrada √≥timos
               ‚Ä¢ Gerenciamento de risco

            Data da an√°lise: {self.current_date}
            """,
            expected_output=f"""An√°lise t√©cnica detalhada de {symbol} contendo:
            
            üéØ RESUMO T√âCNICO EXECUTIVO
            ‚Ä¢ Bias t√©cnico atual (Altista/Baixista/Neutro)
            ‚Ä¢ Recomenda√ß√£o t√©cnica de curto/m√©dio prazo
            ‚Ä¢ Principais n√≠veis a monitorar
            ‚Ä¢ Setup de maior probabilidade
            
            üìà AN√ÅLISE DE TEND√äNCIA
            ‚Ä¢ Tend√™ncia em m√∫ltiplos timeframes
            ‚Ä¢ Estrutura t√©cnica atual
            ‚Ä¢ Pontos de inflex√£o importantes
            ‚Ä¢ Confirma√ß√µes e invalida√ß√µes
            
            üéöÔ∏è N√çVEIS CR√çTICOS
            ‚Ä¢ Suportes e resist√™ncias principais
            ‚Ä¢ Zonas de decis√£o t√©cnica
            ‚Ä¢ Retra√ß√µes de Fibonacci relevantes
            ‚Ä¢ N√≠veis psicol√≥gicos importantes
            
            üìä INDICADORES T√âCNICOS
            ‚Ä¢ An√°lise dos principais indicadores
            ‚Ä¢ Sinais de entrada e sa√≠da
            ‚Ä¢ Diverg√™ncias identificadas
            ‚Ä¢ Momentum e for√ßa relativa
            
            üïØÔ∏è PADR√ïES GR√ÅFICOS
            ‚Ä¢ Forma√ß√µes t√©cnicas identificadas
            ‚Ä¢ Padr√µes de candlestick relevantes
            ‚Ä¢ Implica√ß√µes dos padr√µes
            ‚Ä¢ Alvos t√©cnicos projetados
            
            üì¶ AN√ÅLISE DE VOLUME
            ‚Ä¢ Perfil de volume atual
            ‚Ä¢ Confirma√ß√µes de movimento
            ‚Ä¢ Diverg√™ncias de volume
            ‚Ä¢ Zonas de maior interesse
            
            üé™ CEN√ÅRIOS T√âCNICOS
            ‚Ä¢ Cen√°rio altista: entrada, alvo, stop
            ‚Ä¢ Cen√°rio baixista: entrada, alvo, stop
            ‚Ä¢ Probabilidades de cada cen√°rio
            ‚Ä¢ Estrat√©gias de posicionamento
            
            ‚ö†Ô∏è GERENCIAMENTO DE RISCO
            ‚Ä¢ N√≠veis de stop loss sugeridos
            ‚Ä¢ Rela√ß√£o risco/retorno
            ‚Ä¢ Sizing de posi√ß√£o recomendado
            ‚Ä¢ Pontos de reavalia√ß√£o
            
            Formato: Markdown com descri√ß√µes t√©cnicas claras e n√≠veis espec√≠ficos""",
            agent=agent,
            context=[research_task],
            output_file=f"reports/technical_{symbol}_{datetime.now().strftime('%Y%m%d_%H%M')}.md"
        )

    def create_daytrader_task(self, symbol: str, agent, research_task: Task, technical_task: Task) -> Task:
        """
        Cria tarefa de consultoria de day trade.
        
        Args:
            symbol: S√≠mbolo da a√ß√£o
            agent: Agente respons√°vel
            research_task: Tarefa de pesquisa
            technical_task: Tarefa de an√°lise t√©cnica
            
        Returns:
            Task: Tarefa de day trade
        """
        return Task(
            description=f"""Desenvolver estrat√©gia completa de day trade para {symbol} baseada em:

            1. SETUP DE DAY TRADE:
               ‚Ä¢ Identifica√ß√£o de setups de alta probabilidade
               ‚Ä¢ An√°lise de m√∫ltiplos timeframes (1min, 5min, 15min, 1h)
               ‚Ä¢ Conflu√™ncias t√©cnicas para entrada
               ‚Ä¢ Hor√°rios de maior volatilidade e volume

            2. ESTRAT√âGIA DE ENTRADA:
               ‚Ä¢ Pontos √≥timos de entrada (pre√ßo espec√≠fico)
               ‚Ä¢ Confirma√ß√µes necess√°rias antes da entrada
               ‚Ä¢ Volume m√≠nimo para validar setup
               ‚Ä¢ Timing ideal para execu√ß√£o

            3. GERENCIAMENTO DE POSI√á√ÉO:
               ‚Ä¢ Stop loss t√©cnico (valor espec√≠fico)
               ‚Ä¢ Take profit prim√°rio e secund√°rio
               ‚Ä¢ Trailing stop para maximizar ganhos
               ‚Ä¢ Sizing de posi√ß√£o baseado em risco

            4. AN√ÅLISE INTRADAY:
               ‚Ä¢ Padr√µes intraday recorrentes
               ‚Ä¢ Suporte e resist√™ncia intraday
               ‚Ä¢ Gap de abertura e suas implica√ß√µes
               ‚Ä¢ Market makers e fluxo de ordens

            5. CATALISADORES DO DIA:
               ‚Ä¢ Eventos que podem impactar o pre√ßo
               ‚Ä¢ Hor√°rios de maior aten√ß√£o
               ‚Ä¢ Not√≠cias ou dados relevantes
               ‚Ä¢ Correla√ß√µes com outros ativos

            6. PLANO DE EXECU√á√ÉO:
               ‚Ä¢ Pre-market: prepara√ß√£o e an√°lise
               ‚Ä¢ Abertura: primeiros minutos
               ‚Ä¢ Meio do dia: oportunidades
               ‚Ä¢ Fechamento: estrat√©gia de sa√≠da

            7. CEN√ÅRIOS ALTERNATIVOS:
               ‚Ä¢ Plan B se setup principal falhar
               ‚Ä¢ Adapta√ß√£o a diferentes condi√ß√µes de mercado
               ‚Ä¢ Gest√£o de drawdown intraday

            Data da opera√ß√£o: {self.current_date}
            Pr√≥xima sess√£o: Considerar abertura do pr√≥ximo preg√£o
            """,
            expected_output=f"""Plano completo de day trade para {symbol} incluindo:
            
            ‚ö° SETUP PRINCIPAL
            ‚Ä¢ Descri√ß√£o do setup de maior probabilidade
            ‚Ä¢ Condi√ß√µes necess√°rias para ativa√ß√£o
            ‚Ä¢ Timeframe principal de opera√ß√£o
            ‚Ä¢ Conflu√™ncias t√©cnicas identificadas
            
            üéØ ESTRAT√âGIA DE ENTRADA
            ‚Ä¢ Pre√ßo de entrada (valor espec√≠fico)
            ‚Ä¢ Confirma√ß√µes antes da execu√ß√£o
            ‚Ä¢ Volume m√≠nimo necess√°rio
            ‚Ä¢ Timing ideal (hor√°rio espec√≠fico)
            
            üõ°Ô∏è GERENCIAMENTO DE RISCO
            ‚Ä¢ Stop loss (valor exato)
            ‚Ä¢ Take profit 1 e 2 (valores espec√≠ficos)
            ‚Ä¢ Tamanho da posi√ß√£o recomendado
            ‚Ä¢ Rela√ß√£o risco/retorno
            
            ‚è∞ CRONOGRAMA INTRADAY
            ‚Ä¢ 09:00-09:30: An√°lise de abertura
            ‚Ä¢ 09:30-11:00: Janela de maior oportunidade
            ‚Ä¢ 11:00-14:00: Monitoramento e ajustes
            ‚Ä¢ 14:00-17:00: Estrat√©gia de fechamento
            
            üìä N√çVEIS INTRADAY CR√çTICOS
            ‚Ä¢ Suporte intraday: R$ XX,XX
            ‚Ä¢ Resist√™ncia intraday: R$ XX,XX
            ‚Ä¢ Zona de stop out: R$ XX,XX
            ‚Ä¢ Zona de realiza√ß√£o: R$ XX,XX
            
            üö® CATALISADORES E ALERTAS
            ‚Ä¢ Eventos do dia que podem impactar
            ‚Ä¢ Hor√°rios de maior aten√ß√£o
            ‚Ä¢ Correla√ß√µes importantes a monitorar
            ‚Ä¢ Indicadores para abortar opera√ß√£o
            
            üì± PLANOS ALTERNATIVOS
            ‚Ä¢ Plan B se setup falhar
            ‚Ä¢ Estrat√©gia para mercado lateral
            ‚Ä¢ A√ß√£o em caso de gap adverso
            ‚Ä¢ Limites de perda do dia
            
            ‚úÖ CHECKLIST DE EXECU√á√ÉO
            ‚Ä¢ [ ] An√°lise pre-market completa
            ‚Ä¢ [ ] N√≠veis marcados no gr√°fico
            ‚Ä¢ [ ] Stop loss configurado
            ‚Ä¢ [ ] Tamanho da posi√ß√£o definido
            ‚Ä¢ [ ] Plano de sa√≠da claro
            
            Formato: Markdown com valores espec√≠ficos e hor√°rios exatos""",
            agent=agent,
            context=[research_task, technical_task],
            output_file=f"reports/daytrader_{symbol}_{datetime.now().strftime('%Y%m%d_%H%M')}.md"
        )

    def create_investment_recommendation_task(self, symbol: str, agent, all_previous_tasks: list) -> Task:
        """
        Cria tarefa de recomenda√ß√£o final de investimento.
        
        Args:
            symbol: S√≠mbolo da a√ß√£o
            agent: Agente respons√°vel
            all_previous_tasks: Lista com todas as tarefas anteriores
            
        Returns:
            Task: Tarefa de recomenda√ß√£o final
        """
        return Task(
            description=f"""Sintetizar todas as an√°lises realizadas sobre {symbol} e elaborar 
            recomenda√ß√£o final abrangente de investimento, considerando:

            1. S√çNTESE ANAL√çTICA:
               ‚Ä¢ Consolida√ß√£o dos insights de pesquisa
               ‚Ä¢ Integra√ß√£o da an√°lise fundamentalista
               ‚Ä¢ Incorpora√ß√£o da an√°lise t√©cnica
               ‚Ä¢ Considera√ß√£o das estrat√©gias de day trade
               ‚Ä¢ Reconcilia√ß√£o de eventuais diverg√™ncias

            2. CEN√ÅRIOS DE INVESTIMENTO:
               ‚Ä¢ Cen√°rio base: probabilidade e retorno esperado
               ‚Ä¢ Cen√°rio otimista: drivers e potencial upside
               ‚Ä¢ Cen√°rio pessimista: riscos e downside protection
               ‚Ä¢ Horizonte temporal para cada cen√°rio

            3. RECOMENDA√á√ÉO ESTRATIFICADA:
               ‚Ä¢ Investidor conservador: estrat√©gia e aloca√ß√£o
               ‚Ä¢ Investidor moderado: estrat√©gia e aloca√ß√£o
               ‚Ä¢ Investidor agressivo: estrat√©gia e aloca√ß√£o
               ‚Ä¢ Trader ativo: t√°ticas de curto prazo

            4. TIMING DE INVESTIMENTO:
               ‚Ä¢ Momento ideal para entrada
               ‚Ä¢ Estrat√©gia de acumula√ß√£o gradual vs entrada √∫nica
               ‚Ä¢ Pontos de reavalia√ß√£o da tese
               ‚Ä¢ Crit√©rios para sa√≠da

            5. GEST√ÉO DE PORTF√ìLIO:
               ‚Ä¢ Peso recomendado no portf√≥lio
               ‚Ä¢ Correla√ß√µes com outros ativos
               ‚Ä¢ Hedging e prote√ß√£o de downside
               ‚Ä¢ Rebalanceamento peri√≥dico

            6. MONITORAMENTO E GATILHOS:
               ‚Ä¢ KPIs fundamentalistas para acompanhar
               ‚Ä¢ N√≠veis t√©cnicos cr√≠ticos
               ‚Ä¢ Eventos corporativos relevantes
               ‚Ä¢ Sinais de deteriora√ß√£o ou melhora

            7. CONSIDERA√á√ïES ESPECIAIS:
               ‚Ä¢ Aspectos tribut√°rios relevantes
               ‚Ä¢ Liquidez e facilidade de execu√ß√£o
               ‚Ä¢ Quest√µes de governan√ßa corporativa
               ‚Ä¢ Fatores ESG (se relevantes)

            Data da recomenda√ß√£o: {self.current_date}
            Validade da an√°lise: 30 dias (sujeita a revis√£o)
            """,
            expected_output=f"""Recomenda√ß√£o de investimento completa para {symbol}:
            
            üèÜ RECOMENDA√á√ÉO EXECUTIVA
            ‚Ä¢ Rating geral: [COMPRA FORTE/COMPRA/MANTENHA/VENDA/VENDA FORTE]
            ‚Ä¢ Pre√ßo-alvo 12 meses: R$ XX,XX
            ‚Ä¢ Potencial de retorno: XX%
            ‚Ä¢ N√≠vel de risco: [BAIXO/M√âDIO/ALTO]
            ‚Ä¢ Convic√ß√£o da recomenda√ß√£o: [ALTA/M√âDIA/BAIXA]
            
            üìã TESE DE INVESTIMENTO
            ‚Ä¢ Raz√µes principais para a recomenda√ß√£o
            ‚Ä¢ Principais catalisadores de valor
            ‚Ä¢ Vantagens competitivas sustent√°veis
            ‚Ä¢ Fatores de diferencia√ß√£o vs peers
            
            üéØ CEN√ÅRIOS DE INVESTIMENTO
            ‚Ä¢ OTIMISTA (30%): Retorno XX% - Drivers espec√≠ficos
            ‚Ä¢ BASE (50%): Retorno XX% - Expectativas realistas
            ‚Ä¢ PESSIMISTA (20%): Retorno XX% - Principais riscos
            
            üë• RECOMENDA√á√ïES POR PERFIL
            ‚Ä¢ CONSERVADOR: Estrat√©gia, % portf√≥lio, timing
            ‚Ä¢ MODERADO: Estrat√©gia, % portf√≥lio, timing
            ‚Ä¢ AGRESSIVO: Estrat√©gia, % portf√≥lio, timing
            ‚Ä¢ TRADER: Setups espec√≠ficos e t√°ticas
            
            ‚è≥ ESTRAT√âGIA DE ENTRADA
            ‚Ä¢ Timing ideal: [IMEDIATA/AGUARDAR CORRE√á√ÉO/GRADUAL]
            ‚Ä¢ Pre√ßo de entrada sugerido: R$ XX,XX
            ‚Ä¢ Estrat√©gia de acumula√ß√£o
            ‚Ä¢ N√≠veis de stop loss: R$ XX,XX
            
            üìà ALVOS E PRAZOS
            ‚Ä¢ Alvo 3 meses: R$ XX,XX (XX%)
            ‚Ä¢ Alvo 6 meses: R$ XX,XX (XX%)
            ‚Ä¢ Alvo 12 meses: R$ XX,XX (XX%)
            ‚Ä¢ Alvo 24 meses: R$ XX,XX (XX%)
            
            ‚ö†Ô∏è PRINCIPAIS RISCOS
            ‚Ä¢ Riscos fundamentalistas identificados
            ‚Ä¢ Riscos t√©cnicos e de timing
            ‚Ä¢ Riscos macroecon√¥micos
            ‚Ä¢ Fatores que invalidariam a tese
            
            üìä M√âTRICAS DE ACOMPANHAMENTO
            ‚Ä¢ Indicadores fundamentalistas chave
            ‚Ä¢ N√≠veis t√©cnicos cr√≠ticos
            ‚Ä¢ Eventos corporativos a monitorar
            ‚Ä¢ Frequ√™ncia de revis√£o recomendada
            
            üîÑ GEST√ÉO DA POSI√á√ÉO
            ‚Ä¢ Peso m√°ximo recomendado no portf√≥lio
            ‚Ä¢ Estrat√©gia de rebalanceamento
            ‚Ä¢ Crit√©rios para aumento/redu√ß√£o da posi√ß√£o
            ‚Ä¢ Pontos de sa√≠da total
            
            üí° CONSIDERA√á√ïES ESPECIAIS
            ‚Ä¢ Aspectos tribut√°rios relevantes
            ‚Ä¢ Quest√µes de liquidez
            ‚Ä¢ Fatores de governan√ßa
            ‚Ä¢ Recomenda√ß√µes complementares
            
            Formato: Relat√≥rio executivo profissional em Markdown""",
            agent=agent,
            context=all_previous_tasks,
            output_file=f"reports/final_recommendation_{symbol}_{datetime.now().strftime('%Y%m%d_%H%M')}.md"
        )

    def create_all_tasks(self, symbol: str, agents: Dict[str, Any]) -> Dict[str, Task]:
        """
        Cria todas as tarefas para an√°lise completa.
        
        Args:
            symbol: S√≠mbolo da a√ß√£o
            agents: Dicion√°rio com todos os agentes
            
        Returns:
            Dict[str, Task]: Dicion√°rio com todas as tarefas
        """
        # Cria as tarefas em ordem de depend√™ncia
        research_task = self.create_research_task(symbol, agents['research'])
        
        fundamental_task = self.create_fundamental_analysis_task(
            symbol, agents['fundamental'], research_task
        )
        
        technical_task = self.create_technical_analysis_task(
            symbol, agents['technical'], research_task
        )
        
        daytrader_task = self.create_daytrader_task(
            symbol, agents['daytrader'], research_task, technical_task
        )
        
        final_task = self.create_investment_recommendation_task(
            symbol, agents['consultant'], 
            [research_task, fundamental_task, technical_task, daytrader_task]
        )
        
        return {
            'research': research_task,
            'fundamental': fundamental_task,
            'technical': technical_task,
            'daytrader': daytrader_task,
            'final_recommendation': final_task
        }


# Fun√ß√£o de conveni√™ncia
def create_market_tasks() -> MarketTasks:
    """
    Fun√ß√£o de conveni√™ncia para criar uma inst√¢ncia de MarketTasks.
    
    Returns:
        MarketTasks: Inst√¢ncia configurada da classe
    """
    return MarketTasks()
